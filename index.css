
/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/

/**
 * @file index.css
 * @description Foundation Design System & Layout Engine.
 * 
 * [MAIN THREAD]: Foco absoluto em 60fps. Este arquivo evita seletores complexos 
 * que aumentam o tempo de "Recalculate Style".
 * 
 * ARQUITETURA DE PERFORMANCE:
 * 1. **Zero-Cost Abstraction:** Uso de CSS puro em vez de bibliotecas CSS-in-JS para 
 *    garantir o "First Contentful Paint" (FCP) mais rápido possível.
 * 2. **Geometry Isolation:** Uso intensivo de `contain: layout style` e `contain: content` 
 *    para isolar sub-árvores do DOM, prevenindo que mudanças em um cartão de hábito 
 *    disparem um reflow global (Layout Thrashing).
 * 3. **GPU Acceleration:** Propriedades como `transform` e `opacity` são priorizadas 
 *    para animações, movendo o processamento da CPU para a GPU.
 * 4. **Adaptive Rendering:** Implementação de `content-visibility: auto` para listas 
 *    longas, reduzindo drasticamente o tempo de "Paint" inicial.
 * 
 * DEPENDÊNCIAS CRÍTICAS:
 * - Variáveis em `:root` são lidas dinamicamente via JS em `utils.ts` (getContrastColor).
 * - Estrutura flexível sincronizada com o motor de renderização em `render.ts`.
 */

:root {
    /* --- DESIGN TOKENS --- */
    /* PERFORMANCE: Uso de variáveis nativas permite trocas de tema com O(1) sem re-renderizar o DOM. */
    
    /* FIX [2025-03-02]: Alterado para #000000 (True Black) para eliminar a percepção de 'fundo azulado' em telas OLED */
    --bg-color: #000000;
    --surface-color: #141414;
    --surface-hover: #2a2a2a;
    --surface-snoozed: var(--surface-color);
    --border-color: var(--surface-hover);
    
    /* MANUTENIBILIDADE: Valores lidos pela função getContrastColor em utils.ts */
    --text-primary: #e5e5e5;
    --text-secondary: #b3b3b3;
    --text-tertiary: #737373;
    --accent-blue: #007aff;
    --accent-blue-hover: #006be0;
    --accent-green: #27ae60;
    --accent-green-hover: #229954;
    --color-red: #e74c3c;
    --color-red-hover: #c0392b;
    --color-yellow: #facc15;
    --surface-light-hover: #d0d0d0;

    /* --- SPACING SYSTEM --- */
    --swipe-action-width: 60px;
    --space-xs: 4px;
    --space-sm: 8px;
    --space-md: 12px;
    --space-lg: 16px;
    --space-section: 20px;
    --space-xl: 24px;
    --space-xxl: 32px;
    --space-3xl: 48px;

    /* --- BORDERS & TRANSITIONS --- */
    --border-radius-small: 6px;
    --border-radius-base: 8px;
    --border-radius-large: 12px;
    --border-radius-pill: 50%;
    --transition-duration: 0.2s;
    --transition-duration-fast: 0.15s;
    --transition-duration-slow: 0.3s;

    /* --- STACKING CONTEXT (Z-INDEX) --- */
    --z-index-base: 1;
    --z-index-sticky: 20; 
    --z-index-content: 2;
    --z-index-indicator: 3;
    --z-index-tooltip: 10;
    --z-index-header: 50; 
    --z-index-footer: 50; 
    --z-index-modal-overlay: 1000;
    --z-index-modal-content: 1001;
    --z-index-stacked-modal: 1010; 
    --z-index-toast: 2000;
}

/* --- ACCELERATED ANIMATIONS --- */
/* PERFORMANCE: Keyframes focados em propriedades que não disparam layout (opacity/transform). */
@keyframes glow-pulse {
    0%, 100% { opacity: 0.4; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.15); }
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

@keyframes icon-pop {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); }
    100% { transform: scale(1); }
}

/* A11Y: Respeita a preferência do sistema, reduzindo carga cognitiva e potencial náusea. */
@media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
    }
}

/* --- RESET & GLOBAL APP SHELL --- */
html {
    height: 100%;
    overflow: hidden; /* Lock body scroll para gerenciar virtualização e overscroll via JS/CSS granular */
    overscroll-behavior: none;
    background-color: var(--bg-color);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    /* PERFORMANCE: Melhora a resposta visual de toque em mobile reduzindo o delay de feedback do browser. */
    -webkit-tap-highlight-color: transparent;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: var(--bg-color);
    color: var(--text-primary);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    -webkit-user-select: none; /* Previne seleção acidental durante gestos de swipe/drag */
    user-select: none;
    touch-action: manipulation; /* BUGFIX: Desabilita zoom por duplo toque para interações personalizadas instantâneas. */
    overscroll-behavior-y: none;
    height: 100dvh; /* Mobile height fix para ignorar barras de navegação */
    overflow: hidden;
}

/* Permite seleção apenas onde o conteúdo é puramente informativo ou copiável */
:is(input, textarea), #ai-response, #stoic-quote-display, #sync-key-text, #confirm-modal-text {
    -webkit-user-select: text;
    user-select: text;
}

/* --- APP CONTAINER --- */
.app-container {
    max-width: 800px;
    margin-inline: auto;
    height: 100dvh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

main {
    display: flex;
    flex-direction: column;
    flex: 1;
    min-height: 0; /* CRÍTICO: Permite que filhos flexíveis (listas) rolem corretamente */
    overflow: hidden;
    position: relative;
}

/* --- HEADER & QUOTE --- */
.app-header {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
    padding-block-start: var(--space-section);
    padding-block-end: var(--space-md);
    padding-inline: var(--space-lg);
    flex-shrink: 0;
    z-index: var(--z-index-header);
    background-color: var(--bg-color);
}

.stoic-quote {
    font-size: 13px;
    font-style: italic;
    color: var(--text-secondary);
    min-height: 2.2em;
    line-height: 1.4;
    transition: opacity 0.5s ease-in-out;
    opacity: 0;
    cursor: pointer;
}
.stoic-quote.visible { opacity: 1; }

/* --- CALENDAR STRIP --- */
.calendar-strip {
    display: flex;
    gap: var(--space-sm);
    overflow-x: auto;
    scrollbar-width: none;
    flex: 1;
    min-width: 0;
    position: relative;
    /* PERFORMANCE: Isola o layout e pintura, evitando que scrolls no calendário disparem reflows no resto da UI. */
    contain: content;
    overscroll-behavior: contain;
    scroll-snap-type: x proximity;
    padding-inline-end: var(--space-xl);
}
.calendar-strip::-webkit-scrollbar { display: none; }

.day-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-md) var(--space-sm);
    border-radius: var(--border-radius-large);
    cursor: pointer;
    transition: background-color var(--transition-duration), transform 0.1s ease-out;
    flex-shrink: 0; /* DO NOT REFACTOR: Garante integridade da largura em telas pequenas. */
    scroll-snap-align: end;
}

/* TÉCNICA: Anel de Progresso O(1) via CSS Custom Properties. */
.day-progress-ring {
    position: relative;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--border-radius-pill);
}
.day-progress-ring::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: var(--border-radius-pill);
    padding: 2px;
    background: conic-gradient(
        from -90deg,
        var(--accent-blue) 0% var(--completed-percent, 0%),
        #ffffff var(--completed-percent, 0%) calc(var(--completed-percent, 0%) + var(--snoozed-percent, 0%)),
        transparent calc(var(--completed-percent, 0%) + var(--snoozed-percent, 0%)) 100%
    );
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
}

/* --- MAIN HABIT CONTAINER --- */
#habit-container {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    flex: 0 1 auto; /* Smart Flex: Encolhe se necessário, mas não força altura vazia. */
    overflow-y: auto; 
    overflow-x: hidden;
    min-height: 0;
    padding-inline: var(--space-lg);
    padding-top: var(--space-lg);
    padding-bottom: var(--space-xl);
    scroll-behavior: smooth;
    overscroll-behavior-y: none; /* REMOVE Android Blue Glow (Overscroll bug visual) */
    scrollbar-width: none;
}
#habit-container::-webkit-scrollbar { display: none; }

/* PERFORMANCE FIX: Desativa smooth scroll durante drag para sincronia 1:1 com cursor. */
#habit-container.is-dragging {
    scroll-behavior: auto !important;
}

/* --- HABIT GROUP & TIMELINE --- */
.habit-group-wrapper {
    display: flex;
    align-items: flex-start;
    gap: var(--space-md);
    flex: 0 0 auto;
    /* PERFORMANCE: Pula a renderização de grupos fora da tela (ex: Noite quando vendo Manhã). */
    content-visibility: auto;
    contain-intrinsic-size: 100px;
}

.habit-group-wrapper.is-collapsible { display: none; }

.time-marker {
    flex-shrink: 0;
    width: 30px;
    padding-top: 25px;
    color: #ffffff;
    display: flex;
    justify-content: center;
    position: sticky; /* Sticky Behavior dentro do Scroll Unificado */
    top: 10px;
    z-index: var(--z-index-sticky);
    transition: opacity var(--transition-duration);
    pointer-events: none; /* Não bloqueia o drop zone por trás */
}

.habit-group {
    position: relative;
    padding: 0;
    margin: 0;
    list-style: none;
    border-radius: var(--border-radius-large);
    flex-grow: 1;
    min-width: 0;
    min-height: 40px;
}

/* --- HABIT CARD --- */
.habit-card {
    border-radius: var(--border-radius-large);
    margin-block-end: var(--space-sm);
    position: relative;
    overflow: hidden;
    display: flex;
    /* PERFORMANCE: Isola layout e estilo para renderização eficiente de listas longas. */
    contain: layout style;
    touch-action: pan-y;
}

.habit-content-wrapper {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-sm) var(--space-md) var(--space-sm) var(--space-xxl);
    position: relative;
    z-index: var(--z-index-content);
    cursor: pointer;
    /* PERFORMANCE: Cubic-bezier para sensação "Apple-like" sem custo de JS Animation. */
    transition: transform var(--transition-duration-slow) cubic-bezier(0.23, 1, 0.32, 1), background var(--transition-duration);
    border-radius: 9px;
    flex-grow: 1;
}

/* PERFORMANCE: Uso seletivo de will-change apenas sob interação para economizar VRAM. */
.habit-card.is-swiping .habit-content-wrapper,
.habit-card.dragging .habit-content-wrapper {
    will-change: transform;
}

.habit-card:not(.completed):not(.snoozed) .habit-content-wrapper {
    /* 3D EFFECT: Perspectiva via gradiente estático (zero custo de render). */
    background: linear-gradient(180deg, rgba(255, 255, 255, 0.05) 0%, transparent 60%), var(--bg-color);
}

.habit-card.completed .habit-content-wrapper { 
    background: color-mix(in srgb, var(--accent-blue) 20%, var(--bg-color));
}

.habit-card.dragging { opacity: 0.4; }

/* --- CHART (AUTO-FOOTER) --- */
.chart-container {
    padding: var(--space-lg);
    background-color: var(--bg-color);
    border-radius: var(--border-radius-large);
    /* PERFORMANCE: Layout isolado permite que tooltips flutuem sem causar re-layout da main area. */
    contain: layout style;
    /* PERFORMANCE: Otimização nativa de rendering para elementos no footer. */
    content-visibility: auto;
    contain-intrinsic-size: 80px;
    flex-shrink: 0;
    margin-top: var(--space-lg);
    margin-inline: var(--space-lg); 
    margin-bottom: var(--space-sm);
    border: 1px solid rgba(255, 255, 255, 0.3);
    z-index: var(--z-index-footer);
}

.chart-line { 
    fill: none; 
    stroke: var(--accent-blue); 
    stroke-width: 2.5; 
    stroke-linecap: round; 
    stroke-linejoin: round;
    /* VISUAL: Filtro drop-shadow é performático se a geometria do SVG for simples. */
    filter: drop-shadow(0 0 3px var(--accent-blue));
}

.chart-tooltip {
    position: absolute; 
    top: 0; left: 0; 
    background-color: var(--bg-color);
    border: 1px solid var(--border-color);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    pointer-events: none; 
    opacity: 0;
    /* PERFORMANCE: Movido via transform para evitar layout thrashing durante o rastreamento do mouse. */
    will-change: transform, opacity;
    z-index: var(--z-index-tooltip); 
    min-width: 150px;
}

/* --- MODALS --- */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    /* PERFORMANCE: Backdrop-filter é custoso em mobile. Limitamos o uso a camadas superiores. */
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: var(--z-index-modal-overlay);
    opacity: 0;
    visibility: hidden;
    transition: opacity var(--transition-duration-slow), visibility var(--transition-duration-slow);
    overscroll-behavior: contain;
}
.modal-overlay.visible { opacity: 1; visibility: visible; }

.modal-content {
    background: var(--surface-color);
    border: 1px solid var(--border-color);
    border-radius: var(--space-lg);
    width: 90%;
    max-width: 400px;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    padding: var(--space-xl);
    overflow-y: auto;
    z-index: var(--z-index-modal-content);
    overscroll-behavior: contain;
}

/* --- DRAG & DROP UTILS --- */
.drag-image-ghost {
    position: absolute;
    top: -9999px;
    left: -9999px;
    background-color: var(--surface-hover);
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    border-radius: 9px;
    pointer-events: none;
    z-index: 9999;
    opacity: 0.95;
    transform: scale(1.02);
}

.drop-indicator {
    position: absolute;
    height: 3px;
    background-color: var(--accent-blue);
    border-radius: 2px;
    left: var(--space-sm);
    right: var(--space-sm);
    opacity: 0;
    pointer-events: none;
    transition: top var(--transition-duration-fast) ease-out, opacity var(--transition-duration-fast) ease-out;
    z-index: var(--z-index-indicator);
    will-change: top, opacity;
}
.drop-indicator.visible { opacity: 1; }

/* --- FORM COMPONENTS (APPLE STYLE) --- */
.segmented-control {
    display: flex;
    background-color: var(--bg-color);
    border-radius: var(--border-radius-base);
    padding: 4px;
    width: 100%;
    gap: 4px;
}
.segmented-control-option {
    flex: 1;
    padding: 10px 0;
    font-size: 12px;
    font-weight: 500;
    color: var(--text-secondary);
    background-color: transparent;
    border: none;
    border-radius: var(--border-radius-small);
    cursor: pointer;
    transition: background-color var(--transition-duration), color var(--transition-duration);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
}
.segmented-control-option.selected {
    background-color: var(--accent-blue);
    color: white;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

/* --- SCROLLBARS (CUSTOM) --- */
/* PERFORMANCE: Scrollbars personalizadas são renderizadas na thread de pintura do browser, sem overhead de JS. */
.modal-content, #explore-habit-list, #habit-list, #ai-response, #icon-picker-grid, #color-picker-grid, #edit-habit-form {
    scrollbar-width: thin;
    scrollbar-color: color-mix(in srgb, var(--text-tertiary) 60%, transparent) transparent;
}
.modal-content::-webkit-scrollbar, #explore-habit-list::-webkit-scrollbar { width: 6px; }
.modal-content::-webkit-scrollbar-thumb, #explore-habit-list::-webkit-scrollbar-thumb {
    background-color: color-mix(in srgb, var(--text-tertiary) 60%, transparent);
    border-radius: 3px;
}

/* --- RESPONSIVITY --- */
@media (max-width: 767px) {
    .header-title-desktop { display: none; }
    .header-title-mobile { display: block; }
}

@media (min-width: 768px) {
    /* PERFORMANCE: Grid layout para desktop maximiza espaço sem aumentar custo de layout. */
    .habit-group {
        display: flex; flex-wrap: wrap;
        gap: var(--space-sm);
    }
    .habit-card {
        flex: 1 1 calc(50% - var(--space-sm));
        min-width: 150px;
    }
    .habit-details .name { font-size: 17px; }
}
